<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Highveld Biotech — Assistant</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="/static/quote.css" />
</head>

<body>
    <header class="app-header">
        <div class="wrap">
            <div class="brand">
                <div class="title">
                    <div class="name">Highveld Biotech</div>
                    <div class="tag">Scientific Excellence</div>
                </div>
            </div>
        </div>
    </header>

    <main class="shell">
        <section class="card">
            <div class="toolbar">
                <div class="hint">Ask about tests, pricing, TAT, logistics, or request a PDF quote.</div>
            </div>

            <div id="chat" class="chat-window" aria-live="polite"></div>

            <div class="input-bar">
                <div class="input">
                    <textarea id="input" placeholder="Type your message… (Shift+Enter for new line)"></textarea>
                </div>
                <button id="send" class="send" type="button">Send</button>
            </div>
        </section>

        <!-- Footer note removed per request to keep UI minimal during quoting -->
    </main>

    <script>
        const chatEl = document.getElementById('chat');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        // No floating PDF button; generation is chat-driven
        let wasReadyForPdf = false;

        function showPdfToast() {}

        async function generatePdf() {
            addMessage('ai', 'Generating your PDF…');
            try {
                const res = await fetch('/api/quote/pdf', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: 'Generate PDF quote', session_id: sessionId })
                });
                const ref = res.headers.get('X-Quote-Ref') || '';
                const valid = res.headers.get('X-Quote-Valid-Until') || '';
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'quote.pdf'; a.click();
                window.URL.revokeObjectURL(url);
                let msg = 'Downloaded your PDF quote.';
                if (ref || valid) {
                    msg = `Your PDF quote${ref ? ' (ref ' + ref + ')' : ''}${valid ? ' — valid until ' + valid : ''} has been downloaded.`;
                }
                addMessage('ai', msg + ' Is there anything else I can assist with? I can share drop-off details, lab hours, sample preparation guidance, or connect you with a consultant.');
            } catch {
                addMessage('ai', 'Could not generate PDF right now.');
            }
        }

        // Simple session continuity across page reloads
        function uuid() { return crypto.randomUUID ? crypto.randomUUID() : (Date.now() + '-' + Math.random().toString(16).slice(2)); }
        const sessionId = (() => {
            try {
                const saved = localStorage.getItem('hvb_session_id');
                if (saved) return saved;
                const sid = uuid();
                localStorage.setItem('hvb_session_id', sid);
                return sid;
            } catch { return uuid(); }
        })();

        function el(tag, cls, text) { const n = document.createElement(tag); if (cls) n.className = cls; if (text !== undefined) n.textContent = text; return n; }
        function addMessage(role, text) {
            const row = el('div', 'msg ' + (role === 'user' ? 'user' : 'ai'));
            row.appendChild(el('div', 'avatar', role === 'user' ? 'U' : 'H'));
            const bubble = el('div', 'bubble', text);
            row.appendChild(bubble);
            // Render quick-reply chips for numbered options
            if (role !== 'user' && /(?:^|\n)\d+\.\s/.test(text)) {
                const lines = text.split('\n');
                const opts = lines.filter(l => /^\d+\.\s+/.test(l)).map(l => ({n: l.split('.')[0].trim(), t: l.replace(/^\d+\.\s+/, '')}));
                if (opts.length) {
                    const chips = el('div', 'chips');
                    opts.forEach(o => {
                        const b = el('button', 'chip', o.n + '. ' + o.t.split('—')[0].trim());
                        b.type = 'button';
                        b.addEventListener('click', () => sendMessage(o.n));
                        chips.appendChild(b);
                    });
                    row.appendChild(chips);
                }
            }
            chatEl.appendChild(row);
            chatEl.scrollTop = chatEl.scrollHeight;
        }
        function addSpinner() {
            const row = el('div', 'msg ai'); row.id = 'spinner-row';
            row.innerHTML = '<div class="avatar">H</div><div class="bubble"><span class="spinner"></span> Thinking…</div>';
            chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
        }
        function removeSpinner() { const s = document.getElementById('spinner-row'); if (s) s.remove(); }

        async function sendMessage(text) {
            if (!text || !text.trim()) return;
            addMessage('user', text.trim());
            inputEl.value = '';
            addSpinner();
            try {
                const res = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ question: text.trim(), session_id: sessionId })
                });
                const data = await res.json();
                removeSpinner();
                const answer = typeof data.answer === 'string' ? data.answer : JSON.stringify(data);
                addMessage('ai', answer);
                try {
                    const ready = data && data.meta && data.meta.ready_for_pdf;
                    // Keep button hidden; use chat-only CTA
                    if (ready && !wasReadyForPdf) {
                        addMessage('ai', 'Everything looks good. Would you like me to generate a PDF quote now? Reply "yes" to proceed.');
                    }
                    wasReadyForPdf = !!ready;
                } catch {}
                // Auto-generate if the user typed the command or affirmed when ready
                if (/generate\s+pdf\s+quote/i.test(text) || (wasReadyForPdf && /^\s*yes\b/i.test(text))) {
                    setTimeout(generatePdf, 200);
                }
            } catch {
                removeSpinner();
                addMessage('ai', 'Network error. Please try again.');
            }
        }

        sendBtn.addEventListener('click', () => sendMessage(inputEl.value));
        inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(inputEl.value); } });
        // Handle floating PDF generation
        // No PDF button

        // Client form removed; generation handled by floating button when ready
    </script>
</body>

</html>
